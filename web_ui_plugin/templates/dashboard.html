{% extends "base.html" %}

{% block title %}Dashboard - KufarSearcher{% endblock %}

{% block content %}
<h1 class="mb-3 d-none d-md-block">Dashboard</h1>

<!-- Mobile-optimized stats (single row with 4 columns) -->
<div class="row g-2 mb-3">
    <div class="col-3">
        <div class="card h-100">
            <div class="card-body p-2 text-center">
                <div class="small text-muted mb-1" style="font-size: 0.7rem;">Queries</div>
                <div class="fw-bold" style="font-size: 1.2rem;">{{ db_stats.get('total_searches', 0) }}</div>
                <div class="small text-success" style="font-size: 0.65rem;">{{ db_stats.get('active_searches', 0) }} active</div>
            </div>
        </div>
    </div>

    <div class="col-3">
        <div class="card h-100">
            <div class="card-body p-2 text-center">
                <div class="small text-muted mb-1" style="font-size: 0.7rem;">Items</div>
                <div class="fw-bold" style="font-size: 1.2rem;" id="total-items">{{ db_stats.get('total_items', 0) }}</div>
                <div class="small text-warning" style="font-size: 0.65rem;">{{ db_stats.get('unsent_items', 0) }} new</div>
            </div>
        </div>
    </div>

    <div class="col-3">
        <div class="card h-100">
            <div class="card-body p-2 text-center">
                <div class="small text-muted mb-1" style="font-size: 0.7rem;">API</div>
                <div class="fw-bold" style="font-size: 1.2rem;" id="api-requests">{{ searcher_status.total_api_requests or 0 }}</div>
                <div class="small text-muted" style="font-size: 0.65rem;">requests</div>
            </div>
        </div>
    </div>

    <div class="col-3">
        <div class="card h-100">
            <div class="card-body p-2 text-center">
                <div class="small text-muted mb-1" style="font-size: 0.7rem;">Uptime</div>
                <div class="fw-bold" style="font-size: 0.9rem;" id="uptime">{{ searcher_status.uptime or '0s' }}</div>
                <div class="small text-muted" style="font-size: 0.65rem;">h:m:s</div>
            </div>
        </div>
    </div>
</div>

<!-- Compact Action Buttons (Mobile-optimized) -->
<div class="row g-2 mb-3">
    <div class="col-4">
        <button class="btn btn-success btn-sm w-100" onclick="window.runSearch()" style="font-size: 0.75rem; padding: 0.4rem;">
            <i class="bi bi-arrow-clockwise"></i><span class="d-none d-sm-inline ms-1">Scan</span>
        </button>
    </div>
    <div class="col-4">
        <button class="btn btn-danger btn-sm w-100" onclick="window.clearAllItems()" style="font-size: 0.75rem; padding: 0.4rem;">
            <i class="bi bi-trash"></i><span class="d-none d-sm-inline ms-1">Clear</span>
        </button>
    </div>
    <div class="col-4">
        <a href="/items" class="btn btn-outline-primary btn-sm w-100" style="font-size: 0.75rem; padding: 0.4rem;">
            <i class="bi bi-grid-3x3"></i><span class="d-none d-sm-inline ms-1">All</span>
        </a>
    </div>
</div>

<!-- Recent Items Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0 d-flex align-items-center" style="font-size: 0.9rem;">
                    <i class="bi bi-clock-history me-2"></i>Recent Items (24h)
                </h6>
            </div>
            <div class="card-body">
                <div class="row" id="recent-items-container">
                    <!-- Items will be loaded here by JavaScript auto-refresh -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading recent items...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh interval IDs
let statsRefreshInterval;
let itemsRefreshInterval;

// Initialize auto-refresh on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Initializing dashboard auto-refresh...');
    
    // Load recent items immediately
    loadRecentItems();
    
    // Set up auto-refresh for stats (every 10 seconds)
    statsRefreshInterval = setInterval(function() {
        refreshDashboardStats();
    }, 10000);
    
    // Set up auto-refresh for items (every 30 seconds)
    itemsRefreshInterval = setInterval(function() {
        loadRecentItems();
    }, 30000);
});

// Refresh dashboard stats without page reload
function refreshDashboardStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update stats cards
                document.getElementById('total-items').textContent = data.db_stats.total_items || 0;
                document.getElementById('api-requests').textContent = data.searcher_status.total_api_requests || 0;
                document.getElementById('uptime').textContent = data.searcher_status.uptime || '0s';
                
                console.log('‚úÖ Dashboard stats updated');
            }
        })
        .catch(error => {
            console.error('‚ùå Failed to refresh stats:', error);
        });
}

// Load recent items
function loadRecentItems() {
    fetch('/api/recent-items?limit=24')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to load recent items:', data.error);
                document.getElementById('recent-items-container').innerHTML = 
                    '<div class="col-12 text-center py-3"><p class="text-danger">Failed to load recent items</p></div>';
                return;
            }
            
            const container = document.getElementById('recent-items-container');

            if (!data.items || data.items.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-3"><p class="text-muted">No items found yet</p></div>';
                return;
            }

            // Render items
            let html = '';
            data.items.forEach(item => {
                html += createItemCardHTML(item);
            });

            container.innerHTML = html;
            console.log('‚úÖ Recent items loaded:', data.items.length);
        })
        .catch(error => {
            console.error('‚ùå Failed to load recent items:', error);
            document.getElementById('recent-items-container').innerHTML = 
                '<div class="col-12 text-center py-3"><p class="text-danger">Failed to load items</p></div>';
        });
}

// Create item card HTML
function createItemCardHTML(item) {
    const imageUrl = item.images && item.images.length > 0 ? item.images[0] : '';
    const priceDisplay = formatPrice(item);
    const dateDisplay = item.date || 'Unknown date';
    
    return `
        <div class="col-6 col-sm-4 col-md-3 col-lg-3 col-xl-2 mb-3">
            <div class="card h-100 shadow-sm">
                <a href="${item.item_url}" target="_blank" class="text-decoration-none">
                    <div class="item-image-container" style="aspect-ratio: 4/5; overflow: hidden; background: var(--bg-card); border-radius: 0.25rem 0.25rem 0 0;">
                        ${imageUrl ?
                            `<img src="${imageUrl}" class="d-block w-100 h-100" style="object-fit: cover;" loading="lazy" 
                                  onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\\'d-flex align-items-center justify-content-center h-100 flex-column\\'><i class=\\'bi bi-image\\' style=\\'font-size: 2.5rem; color: #ccc;\\'></i><small class=\\'text-muted mt-2\\'>No image</small></div>';">` :
                            `<div class="bg-light d-flex align-items-center justify-content-center h-100 flex-column">
                                <i class="bi bi-image" style="font-size: 2.5rem; color: #ccc;"></i>
                                <small class="text-muted mt-2">No image</small>
                            </div>`
                        }
                    </div>
                </a>
                <div class="card-body p-2">
                    <h6 class="card-title mb-1 fw-bold" style="font-size: 0.8rem; line-height: 1.2; height: 2.4rem; overflow: hidden;">
                        ${escapeHtml(item.title).substring(0, 50)}${item.title.length > 50 ? '...' : ''}
                    </h6>
                    <div class="mb-1">
                        <div class="fw-bold item-price" style="font-size: 1.1rem;">${priceDisplay}</div>
                    </div>
                    ${item.search_keyword ?
                        `<span class="badge bg-primary" style="font-size: 0.6rem;">${escapeHtml(item.search_keyword).substring(0, 15)}</span>` : ''
                    }
                    <div class="text-muted" style="font-size: 0.65rem; margin-top: 0.25rem;">
                        <i class="bi bi-clock"></i> ${dateDisplay}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Format price (handle both price and price_byn fields)
function formatPrice(item) {
    if (item.price_byn) {
        return `${item.price_byn} BYN`;
    } else if (item.price) {
        return `${item.price} BYN`;
    }
    return 'Price not available';
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Run search (scan all queries)
window.runSearch = function() {
    if (confirm('Start scanning all active queries?')) {
        fetch('/api/run-search', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Scan started successfully!');
                // Refresh stats after a few seconds
                setTimeout(refreshDashboardStats, 3000);
            } else {
                alert('‚ùå Failed to start scan: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('‚ùå Error: ' + error);
        });
    }
};

// Clear all items
window.clearAllItems = function() {
    if (confirm('‚ö†Ô∏è Are you sure you want to clear ALL items? This cannot be undone!')) {
        fetch('/api/clear-items', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ All items cleared successfully!');
                loadRecentItems();
                refreshDashboardStats();
            } else {
                alert('‚ùå Failed to clear items: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('‚ùå Error: ' + error);
        });
    }
};
</script>
{% endblock %}
