{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">Logs</h1>
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-outline-primary btn-sm" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh Now
                </button>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                    <label class="form-check-label" for="autoRefresh">Auto-Refresh: ON</label>
                </div>
                <select class="form-select form-select-sm" id="logLevel" style="width: 120px;" onchange="filterLogs()">
                    <option value="">Log Level</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                    <option value="DEBUG">DEBUG</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Log Entries -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Log Entries</h5>
                <span class="text-muted">{{ logs|length if logs else 0 }} entries</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 180px;">Timestamp</th>
                                <th style="width: 80px;">Level</th>
                                <th style="width: 100px;">Module</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            {% if logs %}
                                {% for log in logs %}
                                <tr class="log-row" data-level="{{ log.level }}"
                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                    title="Click to view full details">
                                    <td class="log-timestamp">{{ log.timestamp if log.timestamp else 'N/A' }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if log.level == 'INFO' %}bg-info
                                            {% elif log.level == 'WARNING' %}bg-warning
                                            {% elif log.level == 'ERROR' %}bg-danger
                                            {% elif log.level == 'DEBUG' %}bg-secondary
                                            {% else %}bg-light text-dark{% endif %}">
                                            {{ log.level }}
                                        </span>
                                    </td>
                                    <td class="log-module">{{ log.source or 'core' }}</td>
                                    <td class="log-message">
                                        {{ log.message[:100] }}{% if log.message|length > 100 %}...{% endif %}
                                        {% if log.details %}
                                            <br><small class="text-muted">{{ log.details[:50] }}{% if log.details|length > 50 %}...{% endif %}</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-muted">
                                        <i class="bi bi-file-text" style="font-size: 2rem;"></i>
                                        <br>No logs available
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.log-timestamp {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85rem;
    color: #6c757d;
}

.log-module {
    font-weight: 600;
    color: #495057;
}

.log-message {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
}

.log-row {
    cursor: pointer;
    transition: background-color 0.2s;
}

.log-row:hover {
    background-color: rgba(0,123,255,0.1);
}

.badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    min-width: 60px;
}

.form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

.table th {
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
    border-bottom: 1px solid #f8f9fa;
    padding: 0.75rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: between;
    align-items: center;
}

.card-header span {
    margin-left: auto;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshInterval;

// Initialize auto-refresh
function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    autoRefreshInterval = setInterval(() => {
        if (document.getElementById('autoRefresh').checked && document.visibilityState === 'visible') {
            refreshLogs(true); // Silent refresh
        }
    }, 5000); // Refresh every 5 seconds like VS5
}

// Refresh logs
function refreshLogs(silent = false) {
    if (!silent) {
        console.log('🔄 Обновление логов...');
    }
    
    fetch('/api/logs/recent?minutes=5')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.logs) {
                updateLogsTable(data.logs);
                updateLogCount(data.count);
                if (!silent) {
                    console.log('✅ Логи обновлены успешно');
                }
            }
        })
        .catch(error => {
            console.error('❌ Ошибка обновления логов:', error);
        });
}

// Update logs table
function updateLogsTable(logs) {
    const tbody = document.getElementById('logsTableBody');
    
    if (!logs || logs.length === 0) {
        return;
    }
    
    // Сохраняем текущую позицию скролла
    const container = document.querySelector('.table-responsive');
    const scrollTop = container.scrollTop;
    
    logs.forEach(log => {
        // Проверяем есть ли уже такой лог
        const existingRows = tbody.querySelectorAll('.log-row');
        const logKey = `${log.created_at}-${log.module}-${log.message.substring(0, 30)}`;
        
        const exists = Array.from(existingRows).some(row => {
            const rowKey = `${row.dataset.timestamp}-${row.children[2].textContent}-${row.children[3].textContent.substring(0, 30)}`;
            return rowKey === logKey;
        });
        
        if (!exists) {
            const row = createLogRow(log);
            tbody.insertBefore(row, tbody.firstChild);
            
            // Ограничиваем количество строк
            if (tbody.children.length > 100) {
                tbody.removeChild(tbody.lastChild);
            }
        }
    });
    
    // Восстанавливаем позицию скролла если пользователь не в самом верху
    if (scrollTop > 0) {
        container.scrollTop = scrollTop;
    }
    
    // Apply current filter
    filterLogs();
}

// Update log count
function updateLogCount(count) {
    const countSpan = document.querySelector('.card-header span');
    if (countSpan) {
        countSpan.textContent = `${count} recent entries`;
    }
}

// Create log row
function createLogRow(log) {
    const row = document.createElement('tr');
    row.className = 'log-row';
    row.dataset.level = log.level;
    row.dataset.timestamp = log.created_at;
    
    const badgeClass = log.level === 'INFO' ? 'bg-info' :
                      log.level === 'WARNING' ? 'bg-warning' :
                      log.level === 'ERROR' ? 'bg-danger' :
                      log.level === 'DEBUG' ? 'bg-secondary' : 'bg-light text-dark';
    
    row.innerHTML = `
        <td class="log-timestamp">${log.timestamp || 'N/A'}</td>
        <td><span class="badge ${badgeClass}">${log.level}</span></td>
        <td class="log-module">${log.source || 'core'}</td>
        <td class="log-message">
            ${log.message.length > 100 ? log.message.substring(0, 100) + '...' : log.message}
            ${log.details ? '<br><small class="text-muted">' + (log.details.length > 50 ? log.details.substring(0, 50) + '...' : log.details) + '</small>' : ''}
        </td>
    `;
    
    return row;
}

// Filter logs by level
function filterLogs() {
    const selectedLevel = document.getElementById('logLevel').value;
    const rows = document.querySelectorAll('.log-row');
    
    rows.forEach(row => {
        if (!selectedLevel || row.dataset.level === selectedLevel) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Auto-refresh toggle
document.getElementById('autoRefresh').addEventListener('change', function() {
    const label = this.nextElementSibling;
    if (this.checked) {
        label.textContent = 'Auto-Refresh: ON';
        startAutoRefresh();
    } else {
        label.textContent = 'Auto-Refresh: OFF';
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    }
});

// Row click handler
document.addEventListener('click', function(e) {
    const row = e.target.closest('.log-row');
    if (row) {
        const cells = row.children;
        const logDetails = {
            timestamp: cells[0].textContent,
            level: cells[1].textContent.trim(),
            module: cells[2].textContent,
            message: cells[3].textContent
        };
        
        // Show detailed log in a modal or alert
        const details = `Time: ${logDetails.timestamp}\nLevel: ${logDetails.level}\nModule: ${logDetails.module}\nMessage: ${logDetails.message}`;
        
        // Create a modal or use browser alert for now
        if (confirm('Log Details:\n\n' + details + '\n\nClick OK to copy to clipboard')) {
            navigator.clipboard.writeText(details).then(() => {
                showAlert('Log details copied to clipboard', 'success');
            });
        }
    }
});

// Start auto-refresh on page load
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden' && autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    } else if (document.visibilityState === 'visible' && document.getElementById('autoRefresh').checked) {
        startAutoRefresh();
    }
});
</script>
{% endblock %}