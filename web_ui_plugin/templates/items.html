{% extends "base.html" %}

{% block title %}Items - KufarSearcher{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
            <h1 class="h3 mb-0">
                <i class="fas fa-box me-2"></i>Items
            </h1>
            
            <!-- Search Form - Mobile Responsive -->
            <form method="GET" class="d-flex w-100 w-md-auto" style="max-width: 400px;">
                <input type="text" name="search" class="form-control me-2 flex-grow-1" 
                       placeholder="Search items... (use ; for multiple terms)" 
                       value="{{ search_filter }}" 
                       style="min-width: 0;"
                       title="Use semicolon (;) to search for multiple terms. Example: Alpha; –ü—É—Ö–æ–≤–∏–∫–∏">
                <button type="submit" class="btn btn-outline-primary flex-shrink-0">
                    <i class="fas fa-search"></i>
                </button>
                {% if search_filter %}
                <a href="{{ url_for('items') }}" class="btn btn-outline-secondary ms-2 flex-shrink-0">
                    <i class="fas fa-times"></i>
                </a>
                {% endif %}
            </form>
        </div>
    </div>
</div>

{% if items %}
    <!-- Items Grid with Infinite Scroll -->
    <div class="row" id="items-grid-container">
        {% for item in items %}
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
            <div class="card h-100">
                <!-- Clickable Image with 4:5 aspect ratio -->
                <a href="{{ item.url }}" target="_blank" class="text-decoration-none position-relative d-block">
                    {% if item.images and item.images|length > 0 %}
                        <div style="aspect-ratio: 4/5; overflow: hidden; position: relative;">
                            <img src="{{ item.images[0] }}" class="d-block w-100 h-100" alt="Item image" 
                                 style="object-fit: cover; object-position: center;">
                        </div>
                    {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center" 
                             style="aspect-ratio: 4/5;">
                            <i class="fas fa-image fa-3x text-muted"></i>
                        </div>
                    {% endif %}
                </a>
                
                <div class="card-body d-flex flex-column p-3">
                    <!-- Title -->
                    <h6 class="card-title mb-2 fw-bold" style="font-size: 14px; line-height: 1.3;">
                        {{ item.title[:60] }}{% if item.title|length > 60 %}...{% endif %}
                    </h6>
                    
                    <!-- Price with Size -->
                    <div class="mb-2">
                        <span class="fw-bold text-dark" style="font-size: 16px;">{{ format_price_with_size(item) | safe }}</span>
                    </div>
                    
                    <!-- Location -->
                    <p class="text-muted mb-2" style="font-size: 13px;">
                        {% if item.location and item.location != '' %}
                            {{ item.location }}
                        {% else %}
                            –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
                        {% endif %}
                    </p>
                    
                    <!-- Search Query Name (Clickable Tag) -->
                    <div class="mb-2">
                        {% if item.search_url %}
                            <a href="{{ item.search_url }}" target="_blank" 
                               class="badge bg-primary text-decoration-none" 
                               style="font-size: 11px; font-weight: 500;" 
                               title="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ –Ω–∞ Kufar.by">
                                {{ item.search_name or 'Unknown' }}
                            </a>
                        {% else %}
                            <span class="badge bg-secondary" style="font-size: 11px; font-weight: 500;">
                                {{ item.search_name or 'Unknown' }}
                            </span>
                        {% endif %}
                    </div>
                    
                    <div class="mt-auto">
                        <!-- Date/Time -->
                        <div class="mb-2">
                            <small class="text-muted" style="font-size: 11px;">
                                {{ item.created_at.strftime('%Y-%m-%d %H:%M:%S') if item.created_at else 'N/A' }}
                            </small>
                        </div>
                        
                        <!-- View Button -->
                        <a href="{{ item.url }}" target="_blank" class="btn btn-primary w-100" style="font-size: 13px; padding: 8px;">
                            View
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Loading indicator for infinite scroll -->
    <div class="text-center py-4 d-none" id="items-scroll-loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading more...</span>
        </div>
        <p class="text-muted mt-2">Loading more items...</p>
    </div>
    
    <!-- Items count display -->
    <div class="text-center text-muted mb-3" id="items-count-info">
        <small>
            Showing {{ items|length }} of {{ pagination.total }} items
        </small>
    </div>
    
{% else %}
    <!-- No Items -->
    <div class="text-center py-5">
        <i class="fas fa-box fa-4x text-muted mb-3"></i>
        <h4 class="text-muted">No items found</h4>
        {% if search_filter %}
            <p class="text-muted">Try adjusting your search criteria</p>
            <a href="{{ url_for('items') }}" class="btn btn-outline-primary">
                <i class="fas fa-times me-2"></i>Clear Search
            </a>
        {% else %}
            <p class="text-muted">Start by adding some searches to monitor KF</p>
            <a href="{{ url_for('add_search') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add Search
            </a>
        {% endif %}
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Infinite scroll variables
let currentItemsPage = {{ pagination.page if pagination else 1 }};
let isLoadingItems = false;
let hasMoreItemsToLoad = {{ 'true' if pagination and pagination.has_next else 'false' }};
let totalItemsCount = {{ pagination.total if pagination else 0 }};
let loadedItemsCount = {{ items|length if items else 0 }};

// Get current search params
const urlParams = new URLSearchParams(window.location.search);
const searchFilter = urlParams.get('search') || '';
const searchId = urlParams.get('search_id') || '';

// Initialize infinite scroll
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Initializing items infinite scroll...');
    console.log(`üìã Search params: filter="${searchFilter}", id="${searchId}"`);
    console.log(`üìä Initial state: page=${currentItemsPage}, hasMore=${hasMoreItemsToLoad}, total=${totalItemsCount}`);
    
    // Setup infinite scroll listener
    window.addEventListener('scroll', handleItemsInfiniteScroll);
    
    // Update initial count display
    updateItemsCountDisplay();
});

// Handle infinite scroll
function handleItemsInfiniteScroll() {
    if (isLoadingItems || !hasMoreItemsToLoad) return;
    
    const scrollLoading = document.getElementById('items-scroll-loading');
    if (!scrollLoading) return;
    
    const scrollPosition = window.innerHeight + window.scrollY;
    const threshold = document.documentElement.scrollHeight - 800;
    
    if (scrollPosition >= threshold) {
        loadMoreItemsPage();
    }
}

// Load more items
function loadMoreItemsPage() {
    if (isLoadingItems || !hasMoreItemsToLoad) return;
    
    isLoadingItems = true;
    currentItemsPage++;
    
    const scrollLoading = document.getElementById('items-scroll-loading');
    scrollLoading.classList.remove('d-none');
    
    // Build API URL with filters
    let apiUrl = `/api/items?page=${currentItemsPage}&per_page=30`;
    if (searchFilter) {
        apiUrl += `&search=${encodeURIComponent(searchFilter)}`;
    }
    if (searchId) {
        apiUrl += `&search_id=${encodeURIComponent(searchId)}`;
    }
    
    console.log(`üîÑ Loading page ${currentItemsPage}...`);
    console.log(`üîó API URL: ${apiUrl}`);
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (!data.success || !data.items || data.items.length === 0) {
                hasMoreItemsToLoad = false;
                scrollLoading.classList.add('d-none');
                isLoadingItems = false;
                console.log('‚úÖ No more items to load');
                return;
            }
            
            // Render new items
            const container = document.getElementById('items-grid-container');
            data.items.forEach(item => {
                container.insertAdjacentHTML('beforeend', createItemCardHTMLForItemsPage(item));
            });
            
            // Update counts
            loadedItemsCount += data.items.length;
            totalItemsCount = data.pagination?.total || totalItemsCount;
            hasMoreItemsToLoad = data.pagination?.has_next || false;
            
            updateItemsCountDisplay();
            
            scrollLoading.classList.add('d-none');
            isLoadingItems = false;
            
            console.log(`‚úÖ Loaded ${data.items.length} more items (${loadedItemsCount}/${totalItemsCount})`);
        })
        .catch(error => {
            console.error('‚ùå Failed to load more items:', error);
            scrollLoading.classList.add('d-none');
            isLoadingItems = false;
        });
}

// Update items count display
function updateItemsCountDisplay() {
    const countInfo = document.getElementById('items-count-info');
    if (countInfo) {
        countInfo.innerHTML = `<small>Showing ${loadedItemsCount} of ${totalItemsCount} items</small>`;
    }
}

// LEGACY: Keep for compatibility (disabled auto-update on items page)
function updateItemsPage() {
    // Disabled - using infinite scroll instead
    console.log('Auto-update disabled on items page (using infinite scroll)');
}

// LEGACY: Removed - not needed for infinite scroll

function createItemCardHTMLForItemsPage(item) {
    // Single image only - no carousel
    let imageHTML;
    if (item.images && item.images.length > 0) {
        // Always show only first image
        imageHTML = `
            <div style="aspect-ratio: 4/5; overflow: hidden; position: relative;">
                <img src="${escapeHtml(item.images[0])}" class="d-block w-100 h-100" alt="Item image" 
                     style="object-fit: cover; object-position: center;">
            </div>
        `;
    } else {
        // No images - placeholder
        imageHTML = `
            <div class="bg-light d-flex align-items-center justify-content-center" 
                 style="aspect-ratio: 4/5;">
                <i class="fas fa-image fa-3x text-muted"></i>
            </div>
        `;
    }
    
    const title = item.title && item.title.length > 60 ? item.title.substring(0, 60) + '...' : (item.title || 'No title');
    const location = (item.location && item.location !== '') ? item.location : '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
    const search_name = item.search_name || '';
    const created_at = item.created_at ? new Date(item.created_at).toLocaleString() : '';
    
    // Format price with size exactly like the original template
    const priceWithSize = formatPriceWithSizeForItems(item);
    
    return `
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
            <div class="card h-100">
                <!-- Clickable Image with 4:5 aspect ratio -->
                <a href="${escapeHtml(item.url)}" target="_blank" class="text-decoration-none position-relative d-block">
                    ${imageHTML}
                </a>
                
                <div class="card-body d-flex flex-column p-3">
                    <!-- Title -->
                    <h6 class="card-title mb-2 fw-bold" style="font-size: 14px; line-height: 1.3;">
                        ${escapeHtml(title)}
                    </h6>
                    
                    <!-- Price with Size -->
                    <div class="mb-2">
                        <span class="fw-bold text-dark" style="font-size: 16px;">${priceWithSize}</span>
                    </div>
                    
                    <!-- Location -->
                    <p class="text-muted mb-2" style="font-size: 13px;">
                        ${escapeHtml(location)}
                    </p>
                    
                    <!-- Search Query -->
                    <p class="text-primary mb-2" style="font-size: 12px;">
                        <i class="fas fa-search me-1"></i>${escapeHtml(search_name)}
                    </p>
                    
                    <!-- Date -->
                    <p class="text-muted mb-3" style="font-size: 11px;">
                        ${created_at}
                    </p>
                    
                    <!-- View Button -->
                    <div class="mt-auto">
                        <a href="${escapeHtml(item.url)}" target="_blank" class="btn btn-primary w-100">View</a>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
}

function formatPriceForCard(price, currency = 'BYN') {
    if (!price || price === 0) return '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
    
    // Format number with thousand separators
    const formattedPrice = new Intl.NumberFormat('ru-RU').format(price);
    return `${formattedPrice} ${currency}`;
}

function formatPriceWithSizeForItems(item) {
    // Exactly replicate the server-side format_price_with_size function for items
    const price = item.price || 0;
    const currency = item.currency || 'BYN';
    
    // Format price
    const priceText = price > 0 
        ? new Intl.NumberFormat('ru-RU').format(price).replace(/\s/g, ' ') + ` ${currency}`
        : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
    
    // Extract size - look in raw_data or try to parse from description/title
    let size = '';
    
    // Try to get size from raw_data if available
    if (item.raw_data && typeof item.raw_data === 'object') {
        size = item.raw_data.size || '';
    }
    
    // If no size in raw_data, try to extract from title or description
    if (!size) {
        const textToCheck = [item.title, item.description].join(' ');
        size = extractSizeFromText(textToCheck);
    }
    
    // Combine price and size with HTML formatting exactly like server
    if (size) {
        return `${priceText}<br/><small class='text-muted'>${escapeHtml(size)}</small>`;
    } else {
        return priceText;
    }
}

function extractSizeFromText(text) {
    if (!text) return '';
    
    // Size patterns similar to server-side extraction
    const sizePatterns = [
        /(\d{2,3}\s*\([XSMLXL]+\))/g,  // 48 (M), 52 (XL)
        /(\d{2,3}-\d{2,3}\s*\([XSMLXL]+\))/g,  // 52-54 (XXL)  
        /\b([XSMLXL]{1,3})\b/g,  // XL, XXL standalone
        /—Ä–∞–∑–º–µ—Ä\s+([XSMLXL]|\d{2,3})/gi,  // —Ä–∞–∑–º–µ—Ä L or —Ä–∞–∑–º–µ—Ä 48
    ];
    
    for (const pattern of sizePatterns) {
        const matches = text.match(pattern);
        if (matches) {
            const size = matches[0].trim();
            // Validate it's actually a clothing size
            if (isValidClothingSize(size)) {
                return size;
            }
        }
    }
    
    return '';
}

function isValidClothingSize(size) {
    if (!size) return false;
    
    // Check against obvious false positives
    if (/^(19|20)\d{2}$/.test(size)) return false;  // Years
    if (/^[5-9]\d{2}$/.test(size)) return false;    // Large IDs
    
    // Extract numbers for range validation
    const numbers = size.match(/\d+/g);
    if (numbers) {
        const num = parseInt(numbers[0]);
        if (num >= 25 && num <= 70) return true;  // Reasonable clothing size range
    }
    
    // Letter sizes are usually valid
    if (/^[XSMLXL]{1,4}$/.test(size)) return true;
    
    return false;
}

// LEGACY: Removed - not needed for infinite scroll
</script>
{% endblock %}
