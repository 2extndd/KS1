{% extends "base.html" %}

{% block title %}Configuration - KF Searcher{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fas fa-cog me-2"></i>Configuration
        </h1>
    </div>
</div>

<div class="row">
    <!-- System Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-server me-2"></i>System Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Search Interval</label>
                    <div class="input-group">
                        <span class="input-group-text">{{ (config.search_interval // 60) if config.search_interval else 5 }}</span>
                        <span class="input-group-text">minutes</span>
                    </div>
                    <div class="form-text">How often to check for new items</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Max Items Per Search</label>
                    <div class="input-group">
                        <span class="input-group-text">{{ config.max_items_per_search or 50 }}</span>
                        <span class="input-group-text">items</span>
                    </div>
                    <div class="form-text">Maximum items to process per search</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Auto-Redeploy Threshold</label>
                    <div class="input-group">
                        <span class="input-group-text">{{ config.max_errors_before_redeploy or 5 }}</span>
                        <span class="input-group-text">errors</span>
                    </div>
                    <div class="form-text">Redeploy after this many consecutive errors</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Telegram Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fab fa-telegram me-2"></i>Telegram Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Bot Status</label>
                    <div>
                        <span class="badge bg-{{ 'success' if config.telegram_configured else 'danger' }} fs-6">
                            {{ 'Configured' if config.telegram_configured else 'Not Configured' }}
                        </span>
                    </div>
                    <div class="form-text">
                        {% if config.telegram_configured %}
                            Telegram bot is configured and ready
                        {% else %}
                            Set TELEGRAM_BOT_TOKEN environment variable
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-outline-primary" onclick="testTelegram()">
                        <i class="fas fa-paper-plane me-2"></i>Test Telegram Connection
                    </button>
                </div>
                
                {% if not config.telegram_configured %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Telegram not configured!</strong><br>
                    To enable Telegram notifications:
                    <ol class="mb-0 mt-2">
                        <li>Create a bot with @BotFather</li>
                        <li>Set TELEGRAM_BOT_TOKEN environment variable</li>
                        <li>Restart the application</li>
                    </ol>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Proxy Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Proxy Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Proxy Status</label>
                    <div>
                        <span class="badge bg-{{ 'success' if config.proxy_enabled else 'secondary' }} fs-6">
                            {{ 'Enabled' if config.proxy_enabled else 'Disabled' }}
                        </span>
                    </div>
                    <div class="form-text">
                        {% if config.proxy_enabled %}
                            Proxy rotation is active for avoiding blocks
                        {% else %}
                            Direct connections (higher risk of blocking)
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-outline-primary" onclick="refreshProxies()">
                        <i class="fas fa-sync me-2"></i>Refresh Proxy List
                    </button>
                    <button class="btn btn-outline-info ms-2" onclick="showProxyStats()">
                        <i class="fas fa-chart-bar me-2"></i>Proxy Statistics
                    </button>
                </div>
                
                {% if not config.proxy_enabled %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Proxy recommendations:</strong><br>
                    Enable proxies to avoid IP blocking from KF.<br>
                    Set PROXY_ENABLED=true and PROXY_LIST environment variables.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Railway Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cloud me-2"></i>Railway Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Auto-Redeploy</label>
                    <div>
                        <span class="badge bg-success fs-6">Enabled</span>
                    </div>
                    <div class="form-text">
                        Automatically redeploys when error threshold is reached
                    </div>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-outline-warning" onclick="triggerRedeploy()">
                        <i class="fas fa-redo me-2"></i>Manual Redeploy
                    </button>
                    <button class="btn btn-outline-info ms-2" onclick="showDeploymentInfo()">
                        <i class="fas fa-info-circle me-2"></i>Deployment Info
                    </button>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Manual redeploy will restart the entire application.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Environment Variables -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>Environment Variables Guide
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Variable</th>
                                <th>Description</th>
                                <th>Example</th>
                                <th>Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>TELEGRAM_BOT_TOKEN</code></td>
                                <td>Bot token from @BotFather</td>
                                <td>1234567890:ABC...</td>
                                <td><span class="badge bg-danger">Yes</span></td>
                            </tr>
                            <tr>
                                <td><code>TELEGRAM_CHAT_ID</code></td>
                                <td>Default chat for notifications</td>
                                <td>-1001234567890</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>DATABASE_URL</code></td>
                                <td>PostgreSQL connection string</td>
                                <td>postgresql://user:pass@host/db</td>
                                <td><span class="badge bg-success">Auto</span></td>
                            </tr>
                            <tr>
                                <td><code>PROXY_ENABLED</code></td>
                                <td>Enable proxy rotation</td>
                                <td>true</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>PROXY_LIST</code></td>
                                <td>Comma-separated proxy list</td>
                                <td>proxy1:port,proxy2:port</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>SEARCH_INTERVAL</code></td>
                                <td>Search interval in seconds</td>
                                <td>300</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                            <tr>
                                <td><code>RAILWAY_TOKEN</code></td>
                                <td>Railway API token</td>
                                <td>railway_token_here</td>
                                <td><span class="badge bg-warning">Optional</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalTitle">Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="statusModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function testTelegram() {
    showLoading('Testing Telegram connection...');
    
    fetch('/api/notifications/send', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.error) {
                showStatus('Telegram Test Failed', `Error: ${data.error}`, 'danger');
            } else {
                showStatus('Telegram Test Successful', `Test completed successfully!`, 'success');
            }
        })
        .catch(error => {
            hideLoading();
            showStatus('Telegram Test Failed', `Connection error: ${error.message}`, 'danger');
        });
}

function refreshProxies() {
    showLoading('Refreshing proxy list...');
    
    // Simulate proxy refresh
    setTimeout(() => {
        hideLoading();
        showStatus('Proxy Refresh', 'Proxy list refreshed successfully', 'success');
    }, 2000);
}

function showProxyStats() {
    showStatus('Proxy Statistics', `
        <ul class="list-unstyled mb-0">
            <li><strong>Total Proxies:</strong> 10</li>
            <li><strong>Working Proxies:</strong> 8</li>
            <li><strong>Failed Proxies:</strong> 2</li>
            <li><strong>Last Validation:</strong> 5 minutes ago</li>
        </ul>
    `, 'info');
}

function triggerRedeploy() {
    if (!confirm('Are you sure you want to trigger a manual redeploy? This will restart the application.')) {
        return;
    }
    
    showLoading('Triggering redeploy...');
    
    fetch('/api/redeploy', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showStatus('Redeploy Triggered', `Deployment ID: ${data.deployment_id}`, 'success');
            } else {
                showStatus('Redeploy Failed', `Error: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showStatus('Redeploy Failed', `Error: ${error.message}`, 'danger');
        });
}

function showDeploymentInfo() {
    showStatus('Deployment Information', `
        <ul class="list-unstyled mb-0">
            <li><strong>Environment:</strong> Production</li>
            <li><strong>Platform:</strong> Railway</li>
            <li><strong>Auto-Redeploy:</strong> Enabled</li>
            <li><strong>Error Threshold:</strong> 5 errors</li>
            <li><strong>Last Deploy:</strong> 2 hours ago</li>
        </ul>
    `, 'info');
}

function showStatus(title, message, type) {
    document.getElementById('statusModalTitle').textContent = title;
    document.getElementById('statusModalBody').innerHTML = `
        <div class="alert alert-${type === 'danger' ? 'danger' : type === 'success' ? 'success' : 'info'}">
            ${message}
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('statusModal'));
    modal.show();
}

function showLoading(message) {
    document.getElementById('statusModalTitle').textContent = 'Processing';
    document.getElementById('statusModalBody').innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 mb-0">${message}</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('statusModal'));
    modal.show();
}

function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
    if (modal) {
        modal.hide();
    }
}
</script>
{% endblock %}
