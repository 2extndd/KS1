#!/usr/bin/env python3
"""
–ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è KufarSearcher
–†–∞—Å—á–µ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Kufar.by –ø—Ä–∏ Query Refresh Delay = 10 —Å–µ–∫—É–Ω–¥
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from configuration_values import get_search_interval
from db import get_db

def analyze_scanner_frequency():
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é —á–∞—Å—Ç–æ—Ç—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    print("üîç –ê–ù–ê–õ–ò–ó –ß–ê–°–¢–û–¢–´ –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø KUFARSEARCHER")
    print("=" * 60)
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    try:
        interval_seconds = get_search_interval()
        print(f"üìä –¢–µ–∫—É—â–∏–π Query Refresh Delay: {interval_seconds} —Å–µ–∫—É–Ω–¥")
        print(f"üìä –≠—Ç–æ —Ä–∞–≤–Ω–æ: {interval_seconds/60:.1f} –º–∏–Ω—É—Ç")
        print()
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e}")
        interval_seconds = 10  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        print(f"üìä –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {interval_seconds} —Å–µ–∫—É–Ω–¥")
        print()
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    try:
        get_db().init_database()
        active_searches = get_db().get_active_searches()
        num_filters = len(active_searches)
        print(f"üéØ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤: {num_filters}")
        
        if num_filters == 0:
            print("‚ö†Ô∏è  –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")
            return
        
        print("\nüìã –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤:")
        for i, search in enumerate(active_searches, 1):
            print(f"   {i}. {search['name']}")
        print()
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ –ë–î: {e}")
        num_filters = 3  # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 3 —Ñ–∏–ª—å—Ç—Ä–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
        print(f"üéØ –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤: {num_filters}")
        print()
    
    # –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∏–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    print("‚öôÔ∏è –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´ –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê:")
    print("-" * 40)
    print("1. ‚è∞ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (60 —Å–µ–∫—É–Ω–¥)")
    print(f"2. üîç –í –∫–∞–∂–¥–æ–º —Ü–∏–∫–ª–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å {num_filters} —Ñ–∏–ª—å—Ç—Ä–æ–≤")
    print(f"3. ‚úÖ –§–∏–ª—å—Ç—Ä –≥–æ—Ç–æ–≤, –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ ‚â•{interval_seconds} —Å–µ–∫—É–Ω–¥ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
    print("4. üöÄ –ì–æ—Ç–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å–∫–∞–Ω–∏—Ä—É—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ")
    print("5. ‚è±Ô∏è –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
    print()
    
    # –†–∞—Å—á–µ—Ç —á–∞—Å—Ç–æ—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
    print("üìä –ß–ê–°–¢–û–¢–ê –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø –û–î–ù–û–ì–û –§–ò–õ–¨–¢–†–ê:")
    print("-" * 45)
    scans_per_hour_per_filter = 3600 / interval_seconds
    scans_per_day_per_filter = 24 * scans_per_hour_per_filter
    
    print(f"‚Ä¢ –û–¥–∏–Ω —Ñ–∏–ª—å—Ç—Ä —Å–∫–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ: {interval_seconds} —Å–µ–∫—É–Ω–¥")
    print(f"‚Ä¢ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –æ–¥–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –≤ —á–∞—Å: {scans_per_hour_per_filter:.1f}")
    print(f"‚Ä¢ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –æ–¥–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –≤ –¥–µ–Ω—å: {scans_per_day_per_filter:.0f}")
    print()
    
    # –†–∞—Å—á–µ—Ç –æ–±—â–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Kufar.by
    print("üåê –û–ë–©–ê–Ø –ù–ê–ì–†–£–ó–ö–ê –ù–ê KUFAR.BY:")
    print("-" * 35)
    total_requests_per_hour = num_filters * scans_per_hour_per_filter
    total_requests_per_day = num_filters * scans_per_day_per_filter
    
    print(f"‚Ä¢ –û–±—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Kufar.by –≤ —á–∞—Å: {total_requests_per_hour:.0f}")
    print(f"‚Ä¢ –û–±—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Kufar.by –≤ –¥–µ–Ω—å: {total_requests_per_day:.0f}")
    print(f"‚Ä¢ –°—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤: {total_requests_per_hour/60:.1f} –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É")
    print()
    
    # –ê–Ω–∞–ª–∏–∑ –ø–∏–∫–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
    print("‚ö° –ê–ù–ê–õ–ò–ó –ü–ò–ö–û–í–û–ô –ù–ê–ì–†–£–ó–ö–ò:")
    print("-" * 30)
    print("üî¥ –í–ê–ñ–ù–û: –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –º–æ–≥—É—Ç —Å—Ç–∞—Ç—å –≥–æ—Ç–æ–≤—ã–º–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª—É—á–∞—è—Ö:")
    print("   1. üöÄ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª–∏—Å—å)")
    print("   2. üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")
    print("   3. ‚è±Ô∏è –ï—Å–ª–∏ –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ")
    print()
    print(f"   –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –≤—Å–µ {num_filters} –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è –∑–∞ ~{num_filters * 3.5:.1f} —Å–µ–∫—É–Ω–¥")
    print(f"   (—Å —É—á–µ—Ç–æ–º –∑–∞–¥–µ—Ä–∂–∫–∏ 2-5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏)")
    print()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∏—Å–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    print("‚ö†Ô∏è  –û–¶–ï–ù–ö–ê –†–ò–°–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò:")
    print("-" * 30)
    if total_requests_per_hour > 1000:
        risk_level = "üî¥ –í–´–°–û–ö–ò–ô"
    elif total_requests_per_hour > 500:
        risk_level = "üü° –°–†–ï–î–ù–ò–ô"
    else:
        risk_level = "üü¢ –ù–ò–ó–ö–ò–ô"
    
    print(f"–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞: {risk_level}")
    print(f"‚Ä¢ {total_requests_per_hour:.0f} –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å —ç—Ç–æ {total_requests_per_hour/60:.2f} –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É")
    
    if total_requests_per_hour > 360:  # –ë–æ–ª—å—à–µ 6 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
        print("‚ö†Ô∏è  –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –£–≤–µ–ª–∏—á—å—Ç–µ Query Refresh Delay!")
        recommended_delay = max(60, int(num_filters * 10))
        print(f"   –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {recommended_delay} —Å–µ–∫—É–Ω–¥")
        print(f"   –≠—Ç–æ —Å–Ω–∏–∑–∏—Ç –Ω–∞–≥—Ä—É–∑–∫—É –¥–æ ~{(num_filters * 3600 / recommended_delay):.0f} –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å")
    else:
        print("‚úÖ –¢–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–µ–º–ª–µ–º–∞—è –¥–ª—è Kufar.by")
    
    print()
    
    # –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞–±–æ—Ç—ã
    print("üìÖ –ü–†–ò–ú–ï–† –†–ê–ë–û–¢–´ –í –¢–ï–ß–ï–ù–ò–ï 5 –ú–ò–ù–£–¢:")
    print("-" * 42)
    
    current_time = 0
    scanned_filters = set()
    
    print("–í—Ä–µ–º—è  | –î–µ–π—Å—Ç–≤–∏–µ")
    print("-------|--------------------------------------------------")
    
    for minute in range(6):  # 6 –º–∏–Ω—É—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        time_str = f"{minute:02d}:00"
        
        if minute == 0:
            print(f"{time_str}  | üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")
            print(f"{time_str}  | ‚úÖ –í—Å–µ {num_filters} —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≥–æ—Ç–æ–≤—ã (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª–∏—Å—å)")
            print(f"{time_str}  | üåê –í—ã–ø–æ–ª–Ω—è–µ–º {num_filters} –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Kufar.by")
            scanned_filters = set(range(num_filters))
            last_scan_time = 0
        else:
            time_passed = minute * 60
            ready_count = 0
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –≥–æ—Ç–æ–≤—ã
            for filter_id in range(num_filters):
                if time_passed >= interval_seconds:
                    ready_count += 1
            
            if ready_count > 0:
                print(f"{time_str}  | ‚úÖ {ready_count} —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≥–æ—Ç–æ–≤—ã –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é")
                print(f"{time_str}  | üåê –í—ã–ø–æ–ª–Ω—è–µ–º {ready_count} –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Kufar.by")
            else:
                print(f"{time_str}  | ‚è±Ô∏è  –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –æ–∂–∏–¥–∞—é—Ç (–¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–ª–æ—Å—å {interval_seconds - (time_passed % interval_seconds)}—Å)")
    
    print()
    print("üîö –ò–¢–û–ì–û:")
    print(f"üìä –ü—Ä–∏ Query Refresh Delay = {interval_seconds}—Å –∏ {num_filters} —Ñ–∏–ª—å—Ç—Ä–∞—Ö:")
    print(f"   ‚Ä¢ {total_requests_per_hour:.0f} –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Kufar.by –≤ —á–∞—Å")
    print(f"   ‚Ä¢ {total_requests_per_day:.0f} –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Kufar.by –≤ –¥–µ–Ω—å")
    print(f"   ‚Ä¢ –ö–∞–∂–¥—ã–π —Ñ–∏–ª—å—Ç—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è {scans_per_hour_per_filter:.1f} —Ä–∞–∑ –≤ —á–∞—Å")

if __name__ == "__main__":
    analyze_scanner_frequency()
